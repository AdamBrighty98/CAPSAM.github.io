---
title: "Homepage"
runtime: shiny
---

## Climate and Air Pollution Synergies Assessment Model (CAPSAM)

Welcome to CAPSAM. A quick and simple model designed to assess how future decarbonisation scenarios will impact air quality.

Fill in the boxes below to more accurately specific your scenario to improve CAPSAM's output and input your scenario data.

```{r, echo=FALSE}


# Loading in data - all impact factors, emission factors, and assumption CSV files
elec_gen_EFs <- read.csv("C:/Users/ab22/Desktop/CAPSAM_CSVs/Elec_EFs_kt_TWh.csv")
impact_factors <- read.csv("C:/Users/ab22/Desktop/CAPSAM_CSVs/UK_to_UK_IFs.csv")

# Simplifying names of emission factors - setting them to recognisable names
# CO2 emission factors
elec_co2_EF_Biomass <- elec_gen_EFs[6,3]
elec_co2_EF_BECCS <- elec_gen_EFs[11,3]
elec_co2_EF_Gas <- elec_gen_EFs[2,3]
elec_co2_EF_GasCCS <- elec_gen_EFs[9,3]
elec_co2_EF_Hydrogen <- elec_gen_EFs[4,3]
elec_co2_EF_Coal <- elec_gen_EFs[1,3]
elec_co2_EF_Waste <- elec_gen_EFs[8,3]
elec_co2_EF_OtherThermal <- elec_gen_EFs[5,3]

# NOx emission factors
elec_nox_EF_Biomass <- elec_gen_EFs[6,4]
elec_nox_EF_BECCS <- elec_gen_EFs[11,4]
elec_nox_EF_Gas <- elec_gen_EFs[2,4]
elec_nox_EF_GasCCS <- elec_gen_EFs[9,4]
elec_nox_EF_Hydrogen <- elec_gen_EFs[4,4]
elec_nox_EF_Coal <- elec_gen_EFs[1,4]
elec_nox_EF_Waste <- elec_gen_EFs[8,4]
elec_nox_EF_OtherThermal <- elec_gen_EFs[5,4]

#PM2.5 emission factors
elec_pm25_EF_Biomass <- elec_gen_EFs[6,5]
elec_pm25_EF_BECCS <- elec_gen_EFs[11,5]
elec_pm25_EF_Gas <- elec_gen_EFs[2,5]
elec_pm25_EF_GasCCS <- elec_gen_EFs[9,5]
elec_pm25_EF_Hydrogen <- elec_gen_EFs[4,5]
elec_pm25_EF_Coal <- elec_gen_EFs[1,5]
elec_pm25_EF_Waste <- elec_gen_EFs[8,5]
elec_pm25_EF_OtherThermal <- elec_gen_EFs[5,5]

#pNOx Impact Factors
elec_nox_IF_Gas <- impact_factors[1,7]
elec_nox_IF_Landfill <- impact_factors[2,7]
elec_nox_IF_Other <- impact_factors[3,7]
print(elec_nox_IF_Other)

#PM2.5 Impact Factors
elec_pm25_IF_Gas <- impact_factors[1,6]
elec_pm25_IF_Landfill <- impact_factors[2,6]
elec_pm25_IF_Other <- impact_factors[3,6]

###################################################################################################


# Variables for initial selection

sectors <- c("Electricity Generation", "Building Heating", "Industrial Combustion")
data_levels_Heating <- c("N/A", "Technologic-specific energy demand (e.g., electricity demand from heat pumps for building heating)", "Number of technologies installed (e.g., number of heat pumps installed)", "Overall sectoral energy demand (e.g., hydrogen demand for building heating)")
data_levels_Industrial <- c("N/A", "Technologic-specific energy demand (e.g., electricity demand from heat pumps for Iron & Steel)", "Overall sectoral energy demand (e.g., hydrogen demand for industrial combustion)" )
countries <- c("UK", "England", "Wales", "Scotland", "Northern Ireland")
impact_factor_choice <- c("UK", "England", "Wales", "Scotland", "Northern Ireland")
units <- c("TWh", "GWh", "PJ", "TJ", "GJ")
lifecycle_data <- c("Electricity Generation", "Hydrogen Production", "None of the above")

# Initial Selection Criteria

library(shiny)
library(shinydashboard)
library(shinydashboardPlus)
library(ggplot2)
library(plotly)
library(tidyverse)
library(dplyr)
library(reshape2)

ui <- dashboardPage(skin = "purple",
  
  dashboardHeader(title = "CAPSAM"),
  
  dashboardSidebar(
    
    
  
  sidebarMenu(
    menuItem("Scenario Questions and Upload", tabName = "upload", icon = icon("upload")),
    menuItem("About CAPSAM", tabName = "about", icon = icon("about"))
    
  )
  ),
  
  dashboardBody(
    
    
    
    
    
    
    fluidRow(
      
      tabBox(title = "Data Input",
             
             tabPanel("Scenario Questions",
         # Selecting which sectors are present in each scenario
         checkboxGroupInput("sectors", "Select all relevant sectors: ", choices = sectors),    
         # Deciding on basic levels of information for Building Heating
         selectInput("dataLevels", "Select the level of detail involved in the building heating scenario. If building heating is not included, select N/A.", choices = data_levels_Heating),    
         # Deciding on basic levels of information for Industrial Combustion
         selectInput("dataLevels", "Select the level of detail involved in the industrial combustion scenario. If industrial combustion is not included, select N/A.", choices = data_levels_Industrial),  
      
  
  ),
  
            tabPanel("Set Parameters and Import csv",
           
           # Selecting lifecycle aspects
           checkboxGroupInput("lifecycle", "What lifecycle information does your scenario contain? Select all relevant boxes", choices = lifecycle_data),
  
           # Selecting base and end years
          numericInput("baseYear", "What is your base (initial) year of your scenario?", value = 0),
          numericInput("endYear", "What is the end year of your scenario?", value = 0),  
           
         # Selecting units found in each scenario
          selectInput("units", "Please Select the Units used within your scenario: ", choices = units),
  
          # Inputting elec gen CSV input
          fileInput("elec_file", "Select your electricity generation file: "),
           
          actionButton("simulate", "Simulate")
    
  )),
  
          tabBox(title = "CSV Download",
           tabPanel("Download", "Click here to download csv templates for your scenario")),
  
  
  
  ),
  

    
   

  
  
  
  
  
  fluidRow(
  
  tabBox(title = "Results", width = 12,
    
    tabPanel("CO2 Emissions", h1(textOutput("caption_co2")), plotOutput("elec_co2"), textOutput("desc")),
    tabPanel("NOx PWMC Impact", h2(textOutput("caption_nox")), plotOutput(("elec_nox"))),
    tabPanel("PM2.5 PWMC Impact", h3(textOutput("caption_pm2.5")), plotOutput("elec_pm25"))
  
  )),
        
  
  
  
    
  ),
  
  
  
)

# Server-side logic

server <- function(input, output, session) {
  
   input_elec_file <- reactive({
      if(is.null(input$elec_file)) {
        return("")
      }
    
      # reading input file now on server side
      read.csv(file = input$elec_file$datapath, fileEncoding='UTF-8-BOM', header = FALSE)
    
    })
  
   # Server side logic - electricity file input with other standard csv files to get emissions and impacts

  # CO2 Emissions - line plot from elec gen (flipped to long)
  # Copy emitting sources and year into new dataframe, multiply by CO2 EF and melt to ggplot
   
     output$elec_co2 <- renderPlot({
        
      req(input_elec_file())
       
       elec_data <- input_elec_file()
       
      # Rotating csv from horizontal to vertical - easier for multiplication
      colnames = as.character(elec_data[ , 1])
      elec_data = data.frame(t(elec_data[ , -1]))
      colnames(elec_data) = colnames
      # Adding Sum column at end of elec data - for PWMC Impacts per Unit Energy
      elec_data$Sum <- rowSums(elec_data[, 2:16], na.rm = TRUE)
      # Removing decimals from year (common syntax) - set to zero decimals in elec_data will roll over!
      elec_data$Year <- format(elec_data$Year, 0)
      
      
       
       
       df_elec_co2_emissions <- elec_data[, 1:9]
       
       df_elec_co2_emissions$Biomass <- df_elec_co2_emissions$Biomass * elec_co2_EF_Biomass
       df_elec_co2_emissions$BECCS <- df_elec_co2_emissions$BECCS * elec_co2_EF_BECCS
       df_elec_co2_emissions$Gas <- df_elec_co2_emissions$Gas * elec_co2_EF_Gas
       df_elec_co2_emissions$`Gas CCS` <- df_elec_co2_emissions$`Gas CCS` * elec_co2_EF_GasCCS
       df_elec_co2_emissions$Hydrogen <- df_elec_co2_emissions$Hydrogen * elec_co2_EF_Hydrogen
       df_elec_co2_emissions$Coal <- df_elec_co2_emissions$Coal * elec_co2_EF_Coal
       df_elec_co2_emissions$Waste <- df_elec_co2_emissions$Waste * elec_co2_EF_Waste
       df_elec_co2_emissions$`Other thermal` <- df_elec_co2_emissions$`Other thermal` * elec_co2_EF_OtherThermal
       df_elec_co2_emissions$`Total Emissions` <- rowSums(df_elec_co2_emissions[,2:9], na.rm = TRUE)
       
       
       long_df_elec_co2_emissions <- melt(df_elec_co2_emissions[, 1:9], id.vars = "Year", variable.name = "Source", value.name = "Emissions", na.rm = TRUE)

   
        ggplot(long_df_elec_co2_emissions,
               aes(Year, Emissions, group = Source, col = Source)) +
        geom_line() + 
        labs(y = "CO2 Emissions (kt)")
        
        
     })
     
     #########################################################################################################
     
     # Nox PWMC Impacts (currently not weighted per unit energy)
     
     
      output$elec_nox <- renderPlot({
        
      req(input_elec_file())
       
       elec_data <- input_elec_file()
       
      # Rotating csv from horizontal to vertical - easier for multiplication
      colnames = as.character(elec_data[ , 1])
      elec_data = data.frame(t(elec_data[ , -1]))
      colnames(elec_data) = colnames
      # Adding Sum column at end of elec data - for PWMC Impacts per Unit Energy
      elec_data$Sum <- rowSums(elec_data[, 2:16], na.rm = TRUE)
      # Removing decimals from year (common syntax) - set to zero decimals in elec_data will roll over!
      elec_data$Year <- format(elec_data$Year, 0)
      
      
       
       
       df_elec_nox_emissions <- elec_data[, 1:9]
       
       df_elec_nox_emissions$Biomass <- df_elec_nox_emissions$Biomass * elec_nox_EF_Biomass
       df_elec_nox_emissions$BECCS <- df_elec_nox_emissions$BECCS * elec_nox_EF_BECCS
       df_elec_nox_emissions$Gas <- df_elec_nox_emissions$Gas * elec_nox_EF_Gas
       df_elec_nox_emissions$`Gas CCS` <- df_elec_nox_emissions$`Gas CCS` * elec_nox_EF_GasCCS
       df_elec_nox_emissions$Hydrogen <- df_elec_nox_emissions$Hydrogen * elec_nox_EF_Hydrogen
       df_elec_nox_emissions$Coal <- df_elec_nox_emissions$Coal * elec_nox_EF_Coal
       df_elec_nox_emissions$Waste <- df_elec_nox_emissions$Waste * elec_nox_EF_Waste
       df_elec_nox_emissions$`Other thermal` <- df_elec_nox_emissions$`Other thermal` * elec_nox_EF_OtherThermal
       df_elec_nox_emissions$`Total Emissions` <- rowSums(df_elec_nox_emissions[, 2:9], na.rm = TRUE)
       
       # Producing PWMC Impacts using UK-to-UK impact factors 
       # Copying - may not need to include new Sums table as could be carried over?
       df_elec_nox_impacts <- df_elec_nox_emissions[,1:9]

       # pNOx Impacts from electricity generation
       df_elec_nox_impacts$Biomass <- df_elec_nox_impacts$Biomass * elec_nox_IF_Other
       df_elec_nox_impacts$BECCS <- df_elec_nox_impacts$BECCS * elec_nox_IF_Other
       df_elec_nox_impacts$Gas <- df_elec_nox_impacts$Gas * elec_nox_IF_Gas
       df_elec_nox_impacts$`Gas CCS` <- df_elec_nox_impacts$`Gas CCS` * elec_nox_IF_Gas
       df_elec_nox_impacts$Hydrogen <- df_elec_nox_impacts$Hydrogen * elec_nox_IF_Gas
       df_elec_nox_impacts$Coal <- df_elec_nox_impacts$Coal * elec_nox_IF_Other
       df_elec_nox_impacts$Waste <- df_elec_nox_impacts$Waste * elec_nox_IF_Other
       df_elec_nox_impacts$`Other thermal` <- df_elec_nox_impacts$`Other thermal` * elec_nox_IF_Other
       df_elec_nox_impacts$`Total Impact` <- rowSums(df_elec_nox_impacts[, 2:9], na.rm = TRUE) 
       
       
       long_df_elec_nox_impacts <- melt(df_elec_nox_impacts[, 1:9], id.vars = "Year", variable.name = "Source", value.name = "PWMC", na.rm = TRUE)

   
        ggplot(long_df_elec_nox_impacts, aes(Year, PWMC, group = Source, col = Source)) +
        geom_line() + 
        labs(y = "NOx PWMC Impact (ng m-3)")
        
        
     })   
     
      #########################################################################################################
     
     # PM2.5 PWMC Impacts (currently not weighted per unit energy)
     
     output$elec_pm25 <- renderPlot({
        
      req(input_elec_file())
       
       elec_data <- input_elec_file()
       
      # Rotating csv from horizontal to vertical - easier for multiplication
      colnames = as.character(elec_data[ , 1])
      elec_data = data.frame(t(elec_data[ , -1]))
      colnames(elec_data) = colnames
      # Adding Sum column at end of elec data - for PWMC Impacts per Unit Energy
      elec_data$Sum <- rowSums(elec_data[, 2:16], na.rm = TRUE)
      # Removing decimals from year (common syntax) - set to zero decimals in elec_data will roll over!
      elec_data$Year <- format(elec_data$Year, 0)
      
      
       
       
       df_elec_pm25_emissions <- elec_data[, 1:9]
       
       
       df_elec_pm25_emissions$Biomass <- df_elec_pm25_emissions$Biomass * elec_pm25_EF_Biomass
       df_elec_pm25_emissions$BECCS <- df_elec_pm25_emissions$BECCS * elec_pm25_EF_BECCS
       df_elec_pm25_emissions$Gas <- df_elec_pm25_emissions$Gas * elec_pm25_EF_Gas
       df_elec_pm25_emissions$`Gas CCS` <- df_elec_pm25_emissions$`Gas CCS` * elec_pm25_EF_GasCCS
       df_elec_pm25_emissions$Hydrogen <- df_elec_pm25_emissions$Hydrogen * elec_pm25_EF_Hydrogen
       df_elec_pm25_emissions$Coal <- df_elec_pm25_emissions$Coal * elec_pm25_EF_Coal
       df_elec_pm25_emissions$Waste <- df_elec_pm25_emissions$Waste * elec_pm25_EF_Waste
       df_elec_pm25_emissions$`Other thermal` <- df_elec_pm25_emissions$`Other thermal` * elec_pm25_EF_OtherThermal
       df_elec_pm25_emissions$`Total Emissions` <- rowSums(df_elec_pm25_emissions[, 2:9], na.rm = TRUE)
       
       # Producing PWMC Impacts using UK-to-UK impact factors 
       # Copying - may not need to include new Sums table as could be carried over?
       df_elec_pm25_impacts <- df_elec_pm25_emissions[,1:9]

       # pNOx Impacts from electricity generation
       df_elec_pm25_impacts$Biomass <- df_elec_pm25_impacts$Biomass * elec_pm25_IF_Other
       df_elec_pm25_impacts$BECCS <- df_elec_pm25_impacts$BECCS * elec_pm25_IF_Other
       df_elec_pm25_impacts$Gas <- df_elec_pm25_impacts$Gas * elec_pm25_IF_Gas
       df_elec_pm25_impacts$`Gas CCS` <- df_elec_pm25_impacts$`Gas CCS` * elec_pm25_IF_Gas
       df_elec_pm25_impacts$Hydrogen <- df_elec_pm25_impacts$Hydrogen * elec_pm25_IF_Gas
       df_elec_pm25_impacts$Coal <- df_elec_pm25_impacts$Coal * elec_pm25_IF_Other
       df_elec_pm25_impacts$Waste <- df_elec_pm25_impacts$Waste * elec_pm25_IF_Other
       df_elec_pm25_impacts$`Other thermal` <- df_elec_pm25_impacts$`Other thermal` * elec_pm25_IF_Other
       df_elec_pm25_impacts$`Total Impact` <- rowSums(df_elec_pm25_impacts[, 2:9], na.rm = TRUE)
       
       
       long_df_elec_pm25_impacts <- melt(df_elec_pm25_impacts[, 1:9], id.vars = "Year", variable.name = "Source", value.name = "PWMC", na.rm = TRUE)

   
        ggplot(long_df_elec_pm25_impacts, aes(Year, PWMC, group = Source, col = Source)) +
        geom_line() + 
        labs(y = "PM2.5 PWMC Impact (ng m-3)")
        
        
     })   
      
     
  
}

shinyApp(ui = ui, server = server)
 
```


